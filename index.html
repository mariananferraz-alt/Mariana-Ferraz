<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Organograma / Cronograma</title>
  <style>
    :root{
      --bg:#0f1720; --card:#111827; --muted:#9ca3af; --accent:#3b82f6;
      color-scheme: dark;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:var(--bg); color:#e6eef6; margin:0; padding:24px;}
    h1{margin:0 0 18px 0; font-size:20px;}
    .controls{margin-bottom:18px; display:flex;gap:8px;flex-wrap:wrap;}
    input[type="text"]{padding:8px 10px;border-radius:8px;border:1px solid #222;background:#0b1220;color:#fff;}
    button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer;}
    .areas{display:flex;flex-wrap:wrap;gap:16px;}
    .area{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); padding:12px; border-radius:10px; width:320px; box-shadow:0 6px 18px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.02);}
    .area h2{margin:0 0 8px 0; font-size:16px;}
    .card{background:var(--card); padding:10px; border-radius:8px; margin-bottom:8px; display:flex;justify-content:space-between;align-items:center; gap:10px; border:1px solid rgba(255,255,255,0.02);}
    .meta{font-size:13px;color:var(--muted);}
    .role{font-weight:600; font-size:14px;}
    .shift{background:rgba(255,255,255,0.04); padding:6px 8px; border-radius:6px; font-size:12px;}
    .empty{color:var(--muted); font-style:italic;}
    @media (max-width:760px){ .areas{flex-direction:column;} .area{width:100%} }
  </style>
</head>
<body>
  <h1>Organograma / Cronograma (dados da planilha)</h1>
  <div class="controls">
    <input id="sheetUrl" type="text" style="min-width:360px"
      value="https://docs.google.com/spreadsheets/d/1ZFBj0NqycrvqHKWbDbiiFOAVA6Qlg5AiD0_10R-fL64/edit?gid=0" />
    <button id="loadBtn">Carregar planilha</button>
    <button id="reloadBtn">Recarregar</button>
  </div>

  <div id="status" class="meta">Status: pronto</div>
  <div id="content" style="margin-top:12px"></div>

  <script>
    // Config: colunas (0-index) — A=0, G=6, K=10, N=13
    const COLS = { colaborador:0, cargo:6, turno:10, area:13 };

    function sheetIdFromUrl(url){
      const m = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)(\/|$)/);
      return m ? m[1] : null;
    }

    function parseCSV(text){
      const rows = [];
      let cur = '';
      let row = [];
      let inQuote = false;
      for (let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];
        if (ch === '"' ){
          if (inQuote && next === '"'){ cur += '"'; i++; continue; }
          inQuote = !inQuote;
          continue;
        }
        if (ch === ',' && !inQuote){ row.push(cur); cur=''; continue; }
        if ((ch === '\n' || ch === '\r') && !inQuote){
          if (ch === '\r' && text[i+1] === '\n'){ /* windows newline */ }
          row.push(cur); cur='';
          if (row.length === 1 && row[0] === ''){ row = []; continue; }
          rows.push(row);
          row = [];
          if (ch === '\r' && text[i+1] === '\n') i++;
          continue;
        }
        cur += ch;
      }
      if (cur !== '' || row.length>0){ row.push(cur); rows.push(row); }
      return rows;
    }

    function groupByArea(rows){
      const groups = {};
      for(let i=1;i<rows.length;i++){
        const r = rows[i];
        if (!r || r.length===0) continue;
        const nome = (r[COLS.colaborador]||'').trim();
        const cargo = (r[COLS.cargo]||'').trim();
        const area = (r[COLS.area]||'Sem área').trim();
        const turno = (r[COLS.turno]||'').trim();
        if (!nome) continue;
        if (!groups[area]) groups[area]=[];
        groups[area].push({nome,cargo,turno});
      }
      return groups;
    }

    function render(groups){
      const content = document.getElementById('content');
      content.innerHTML = '';
      const container = document.createElement('div');
      container.className = 'areas';
      const areas = Object.keys(groups).sort();
      if (areas.length===0){
        content.innerHTML = '<div class="empty">Nenhum dado encontrado — verifique se a planilha está pública e se as colunas existem.</div>';
        return;
      }
      areas.forEach(area=>{
        const box = document.createElement('div');
        box.className='area';
        const title = document.createElement('h2');
        title.textContent = area;
        box.appendChild(title);
        groups[area].forEach(p=>{
          const card = document.createElement('div');
          card.className='card';
          const left = document.createElement('div');
          left.innerHTML = `<div class="role">${escapeHtml(p.nome)}</div><div class="meta">${escapeHtml(p.cargo)}</div>`;
          const right = document.createElement('div');
          right.innerHTML = `<div class="shift">${escapeHtml(p.turno||'—')}</div>`;
          card.appendChild(left); card.appendChild(right);
          box.appendChild(card);
        });
        container.appendChild(box);
      });
      content.appendChild(container);
    }

    function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    async function loadFromSheetUrl(url){
      const status = document.getElementById('status');
      const id = sheetIdFromUrl(url);
      if (!id){ status.textContent = 'URL inválida. Cole a URL completa da planilha.'; return; }
      const gidMatch = url.match(/[?&]gid=(\d+)/);
      const gid = gidMatch ? gidMatch[1] : '0';
      const csvUrl = `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&gid=${gid}`;
      status.textContent = 'Carregando dados...';
      try{
        const res = await fetch(csvUrl);
        if (!res.ok){
          status.textContent = `Falha ao acessar (HTTP ${res.status}). Verifique permissões da planilha.`;
          return;
        }
        const text = await res.text();
        const rows = parseCSV(text);
        const groups = groupByArea(rows);
        render(groups);
        status.textContent = 'Dados carregados com sucesso.';
      }catch(err){
        console.error(err);
        status.textContent = 'Erro ao buscar planilha — veja o console.';
      }
    }

    document.getElementById('loadBtn').addEventListener('click', ()=>{
      const url = document.getElementById('sheetUrl').value.trim();
      loadFromSheetUrl(url);
    });
    document.getElementById('reloadBtn').addEventListener('click', ()=>{
      const url = document.getElementById('sheetUrl').value.trim();
      loadFromSheetUrl(url);
    });

    window.addEventListener('load', ()=>{
      const url = document.getElementById('sheetUrl').value.trim();
      loadFromSheetUrl(url);
    });
  </script>
</body>
</html>
