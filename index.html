<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organograma Automatizado - Real Time</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        h2 { text-align: center; color: #2c3e50; }
        
        #controls { 
            display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; 
            background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; outline: none; }

        /* Estilização dos Cards do Organograma */
        .google-visualization-orgchart-node {
            border: none !important;
            background: transparent !important;
            box-shadow: none !important;
        }

        .node-card {
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 10px;
            min-width: 180px;
            background-color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .node-card:hover { transform: scale(1.05); }
        .node-name { font-weight: bold; font-size: 14px; color: #2c3e50; margin-bottom: 4px; text-transform: uppercase; }
        .node-role { font-size: 12px; color: #7f8c8d; font-style: italic; }
        .node-area { font-size: 11px; font-weight: bold; text-transform: uppercase; margin-top: 5px; color: #e67e22; }
        .node-scale { font-size: 10px; color: #95a5a6; margin-top: 2px; }

        #chart_div { width: 100%; height: 85vh; overflow: auto; display: flex; justify-content: center; padding-top: 20px; }
    </style>
</head>
<body>

    <h2>Organograma Institucional</h2>

    <div id="controls">
        <label for="filterArea">Filtrar por Área:</label>
        <select id="filterArea" onchange="drawChart()">
            <option value="Tudo">Todas as Áreas</option>
        </select>
    </div>

    <div id="chart_div"></div>

    <script>
        // Link direto da sua planilha publicada como CSV
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSEgo7B_rj6vV2lhx6jYP3S3v6q2dBQBpoXKpfeupsgbPGD0jHv-Emm98td1Ch6z1cSCTjtzX2hEQB/pub?output=csv';

        let globalData = [];

        google.charts.load('current', {packages:["orgchart"]});
        google.charts.setOnLoadCallback(fetchData);

        async function fetchData() {
            Papa.parse(CSV_URL, {
                download: true,
                header: false,
                skipEmptyLines: true,
                complete: function(results) {
                    globalData = results.data.slice(1); // Remove a linha de cabeçalho
                    populateFilter(globalData);
                    drawChart();
                }
            });
        }

        function populateFilter(data) {
            const select = document.getElementById('filterArea');
            // Pega áreas únicas da Coluna N (índice 13)
            const areas = [...new Set(data.map(row => row[13]))].filter(Boolean).sort(); 
            areas.forEach(area => {
                let opt = document.createElement('option');
                opt.value = area;
                opt.innerHTML = area;
                select.appendChild(opt);
            });
        }

        function drawChart() {
            const selectedArea = document.getElementById('filterArea').value;
            const dataTable = new google.visualization.DataTable();
            
            dataTable.addColumn('string', 'Entity');
            dataTable.addColumn('string', 'Parent');
            dataTable.addColumn('string', 'ToolTip');

            const rows = [];
            globalData.forEach(row => {
                const nome = row[1] ? row[1].trim() : '';       // Coluna B
                let gestor = row[17] ? row[17].trim() : '';    // Coluna R
                const cargo = row[6] || row[10] || 'Não Informado'; // Coluna G ou K
                const area = row[13] || 'Geral';      // Coluna N
                const escala = `${row[8] || ''} ${row[9] || ''}`; // Colunas I e J

                // REFORÇO PARA O LÍDER: Se for o Takata, ele não tem gestor (fica no topo)
                if (nome.toUpperCase().includes("TAKATA")) {
                    gestor = '';
                }

                // Lógica de Filtro por Área
                if (selectedArea !== "Tudo" && area !== selectedArea) return;

                if (nome !== "") {
                    const cardHtml = `
                        <div class="node-card">
                            <div class="node-name">${nome}</div>
                            <div class="node-role">${cargo}</div>
                            <div class="node-area">${area}</div>
                            <div class="node-scale">Escala: ${escala}</div>
                        </div>
                    `;

                    rows.push([{
                        'v': nome, 
                        'f': cardHtml
                    }, gestor, cargo]);
                }
            });

            dataTable.addRows(rows);
            const chart = new google.visualization.OrgChart(document.getElementById('chart_div'));
            chart.draw(dataTable, {
                allowHtml: true,
                size: 'medium',
                allowCollapse: true
            });
        }
    </script>
</body>
</html>
