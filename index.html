<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organograma Corporativo</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        h2 { text-align: center; color: #1a365d; margin-bottom: 30px; }
        
        #controls { 
            display: flex; justify-content: center; align-items: center; gap: 15px; 
            margin-bottom: 30px; background: white; padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        select { padding: 10px 15px; border-radius: 6px; border: 1px solid #cbd5e0; font-size: 14px; outline: none; min-width: 200px; }

        .google-visualization-orgchart-node {
            border: none !important; background: transparent !important; box-shadow: none !important;
        }

        .node-card {
            border-top: 5px solid #3182ce; border-radius: 8px; padding: 12px;
            min-width: 180px; background-color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.3s;
        }
        
        .node-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        .node-name { font-weight: bold; font-size: 14px; color: #2d3748; margin-bottom: 4px; text-transform: uppercase; }
        .node-role { font-size: 12px; color: #718096; margin-bottom: 6px; }
        .node-area { font-size: 10px; font-weight: bold; background: #ebf8ff; color: #2b6cb0; padding: 2px 8px; border-radius: 20px; display: inline-block; }

        #chart_div { width: 100%; min-height: 80vh; display: flex; justify-content: center; }
    </style>
</head>
<body>

    <h2>Organograma Institucional</h2>

    <div id="controls">
        <label><strong>Filtrar Departamento:</strong></label>
        <select id="filterArea" onchange="drawChart()">
            <option value="Tudo">Visualizar Todos</option>
        </select>
    </div>

    <div id="chart_div"></div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSEgo7B_rj6vV2lhx6jYP3S3v6q2dBQBpoXKpfeupsgbPGD0jHv-Emm98td1Ch6z1cSCTcjtzX2hEQB/pub?output=csv';

        let globalData = [];

        google.charts.load('current', {packages:["orgchart"]});
        google.charts.setOnLoadCallback(fetchData);

        function fetchData() {
            Papa.parse(CSV_URL, {
                download: true,
                header: false,
                skipEmptyLines: true,
                complete: function(results) {
                    // Filtra apenas linhas que possuem um nome na coluna B (índice 1)
                    globalData = results.data.slice(1).filter(row => row[1] && row[1].trim() !== "");
                    populateFilter(globalData);
                    drawChart();
                }
            });
        }

        function populateFilter(data) {
            const select = document.getElementById('filterArea');
            // Remove duplicados, limpa espaços e ordena as áreas (Coluna N - Índice 13)
            const areas = [...new Set(data.map(row => row[13] ? row[13].toString().trim() : 'Geral'))].filter(Boolean).sort(); 
            
            areas.forEach(area => {
                let opt = document.createElement('option');
                opt.value = area;
                opt.innerHTML = area;
                select.appendChild(opt);
            });
        }

        function drawChart() {
            const selectedArea = document.getElementById('filterArea').value;
            const dataTable = new google.visualization.DataTable();
            
            dataTable.addColumn('string', 'Entity');
            dataTable.addColumn('string', 'Parent');
            dataTable.addColumn('string', 'ToolTip');

            const rows = [];
            globalData.forEach(row => {
                // Limpeza rigorosa de strings para evitar erros de validação/espaços
                const nome = row[1].toString().trim();           // Coluna B
                let gestor = row[17] ? row[17].toString().trim() : ''; // Coluna R
                const cargo = (row[6] || row[10] || 'Colaborador').toString().trim(); // Coluna G ou K
                const area = (row[13] || 'Geral').toString().trim(); // Coluna N

                // REFORÇO DE HIERARQUIA: Eduardo sempre é o topo
                if (nome.toUpperCase().includes("TAKATA")) {
                    gestor = '';
                }

                // Lógica de Filtro
                if (selectedArea !== "Tudo" && area !== selectedArea) return;

                const cardHtml = `
                    <div class="node-card">
                        <div class="node-name">${nome}</div>
                        <div class="node-role">${cargo}</div>
                        <div class="node-area">${area}</div>
                    </div>
                `;

                rows.push([{ 'v': nome, 'f': cardHtml }, gestor, cargo]);
            });

            if (rows.length === 0) {
                document.getElementById('chart_div').innerHTML = "<p>Nenhum dado encontrado para esta área. Verifique a planilha.</p>";
                return;
            }

            dataTable.addRows(rows);
            const chart = new google.visualization.OrgChart(document.getElementById('chart_div'));
            chart.draw(dataTable, { allowHtml: true, size: 'medium', allowCollapse: true });
        }
    </script>
</body>
</html>
